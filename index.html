<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <style>
            text {
          font-family: sans-serif;
        }
        .axis--x path {
          display: none;
        }
        .toolTip {
        position: absolute;
        display: none;
        background-color: black;
        color: #fff;
        border: 1px solid #6F257F;
        border-radius: 6px;
        padding: 5px;
        text-align: center;
      }

    svg {
        font: 14px sans-serif;
        padding: 0px;
      }

      .axis,
      .frame {
        shape-rendering: crispEdges;
      }

      .axis line {
        stroke: #ddd;
      }

      .axis path {
        display: none;
      }

      .cell text {
        font-weight: bold;
        text-transform: capitalize;
        fill: black;
      }

      .frame {
        fill: none;
        stroke: #aaa;
      }

      circle {
        fill-opacity: .7;
      }

      circle.hidden {
        fill: #ccc !important;
      }

      .extent {
        fill: #000;
        fill-opacity: .125;
        stroke: #fff;
      }

    </style>
    <title>Visualization</title>
  </head>
  <body>

    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
      <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">Visualization Mini Project 2</a>
      <ul class="navbar-nav px-3">
        <li class="nav-item text-nowrap">
          <a class="nav-link" href="https://filebin.net/afhvaf9mcehduomw/housing2.csv?t=8pcd2s9i">Ames Housing Dataset</a>
        </li>
      </ul>
    </nav>


     <div class="container-fluid" >
      <div class="row">
        <nav class="col-md-2 d-none d-md-block bg-info sidebar">
          <div class="sidebar-sticky">
            <ul class="nav flex-column">
              <li class="nav-item">
                <div class="form-group nav-link">
                  <label for="data">Dataset</label>
                  <select class="form-control" id="data" onchange="saveData(this.value);">
                    <option value="" selected disabled>Please select</option>
                    <option value="orig">Original Dataset</option>
                    <option value = "sampled">Sampled Dataset</option>
                    <option value = "stratified">Stratified Dataset</option>
                    </select>
                </div>
              </li>

               <li class="nav-item">
                <div class="form-group nav-link">
                  <label for="feat">Features</label>
                  <select class="form-control" id="feat" onchange="saveFeat(this.value);">
                    <option value="" selected disabled>Please select</option>
                    <option value="screeplot">Scree Plot</option>
                    <option value = "scatterplot-pca">Scatter Plot PCA</option>
                    <option value = "mds-euc">Scatter Plot MDS Euclidean Distance</option>
                    <option value = "mds-corr">Scatter Plot MDS Correlation Distance</option>
                    <option value = "scatterplot-mat">Scatterplot Matrix</option>
                    <option value = "top3">Three Attributes with highest PCA loadings</option>
                  </select>
                </div>
              </li>
            </ul>

          </div>
        </nav>


        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4">
              <div class = "row">
                  <h4 id="header">
                  </h4>
              </div>
              <div class = "row">
                <ol id ="toplist">

                </ol>
              </div>
              <div class = "row">
                  <div id="graph"></div>
              </div>
        </main>

        <div class="card text-white  mb-3 bg-info col-md-3 right" style="position: absolute; right: 0;
          width: 250px; height: 600px;">
          <div class="card-header">Dataset Info</div>
          <div class="card-body">

            <p class="card-text">Ames DataSet contains information about different houses in Ames. It contains their sale price based on different factors like
              their neighborhood, housestyle, no of floors, parking lot size, no of cars in garage, etc.
              <br>
              <br>
            Its taken from kaggle where end goal was to predict sales price of the house based on all the features.
              There were many features in this dataset with length of 1460 records.
              I chose top 15 features based on their correlation wrt Sales Price.
            </p>
          </div>
      </div>


    </div>
    
    
    <script src="https://d3js.org/d3.v4.js"></script>
<!--     <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.4/lodash.min.js"></script>-->


    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
	


<!-- 	<script type="text/javascript" src="histogram.js"></script>-->


	<script>

	var data, feat;
	var hoverColor = d3.rgb(54, 162, 235, 1);
	var barColor = d3.rgb(54, 162, 235, 0.5);
	var strokeColor = d3.rgb(54, 162, 235, 0.9);
	var strokeBorder = 1;

	function saveData(data){
	  console.log(data);
	  this.data = data;
	}

	function saveFeat(feat){
	  this.feat = feat
    }

	//set the dimensions and margins of the graph
	var margin = {top: 10, right: 30, bottom: 60, left: 50};
	var width = 600 - margin.left - margin.right, height = 550 - margin.top - margin.bottom;


	d3.select('#feat').on('change', function () {   
      d3.select("#toplist").selectAll("*").remove();
	  title_end = ""
      if(data == 'orig')
        title_end = " before Sampling";
      else if(data == 'sampled')
        title_end = " after Random Sampling";
      else
        title_end = " after Stratified Sampling";


		//d3.selectAll("svg").remove();
	    if(data == null){
	      return;
        }
		else if(feat =='top3'){
           d3.json('http://localhost:5000/data/' + data+'/feature/top-3'+ "?" + Math.floor(Math.random() * 1000), function(result) {
             console.log(result);
              d3.selectAll("svg").remove();

             d3.select("#header").text("The Three Attributes with highest PCA loadings are,");

             for ( var i = 0; i < result.length; i++ ) {
                     d3.select("#toplist").append("li").text(result[i]);
             }

           });
		}
		else if(feat == 'scatterplot-mat'){
		  d3.select("#header").text("Scatterplot Matrix of  the three highest PCA loaded attributes");
          d3.select("#header").append("h4").text(title_end);
		  drawScatterplotMatrix(data);

        }
		else if(feat == 'mds-euc'){
		  d3.select("#header").text("MDS (Euclidean distance) in 2D Scatterplot PCA loaded attributes");
		  d3.select("#header").append("h4").text(title_end);


            d3.json('http://localhost:5000/data/' + data+'/feature/mds?metric=euclidean', function(result) {
                drawScatterPlot(result)
           });
        }
		else if(feat == 'mds-corr'){
		  d3.select("#header").text("MDS (Correlation distance) in 2D Scatterplot PCA loaded attributes");
		  d3.select("#header").append("h4").text(title_end);


            d3.json('http://localhost:5000/data/' + data+'/feature/mds?metric=correlation', function(result) {
              drawScatterPlot(result)
            });
        }
		else if(feat == 'scatterplot-pca'){
		  d3.select("#header").text("Top two PCA vectors via 2D scatterplot" + title_end);
          d3.json('http://localhost:5000/data/' + data+'/feature/scatterplot-pca', function(result) {
              drawScatterPlot(result)
           });
        }
		else{
		   d3.select("#header").text("Screeplot" + title_end);

		  d3.json('http://localhost:5000/data/' + data+'/feature/screeplot', function(result) {
	        drawScreePlot(result)
           });
        }
	});

	d3.select('#data').on('change', function () {
     d3.select("#toplist").selectAll("*").remove();

	   title_end = ""
      if(data == 'orig')
        title_end = " before Sampling";
      else if(data == 'sampled')
        title_end = " after Random Sampling";
      else
        title_end = " after Stratified Sampling";

        if(feat == null)
        {
          return;
        }
		else if(feat =='top3'){
           d3.json('http://localhost:5000/data/' + data+'/feature/top-3' + "?" + Math.floor(Math.random() * 1000), function(result) {
              console.log(result);
               d3.selectAll("svg").remove();

              d3.select("#header").text("The Three Attributes with highest PCA loadings are,");

             for ( var i = 0; i < result.length; i++ ) {
                     d3.select("#toplist").append("li").text(result[i]);
             }

            //drawScatterPlot(result)
           });
		}
		else if(feat == 'scatterplot-mat'){

		  d3.select("#header").text("Scatterplot Matrix of  the three highest PCA loaded attributes");
		  d3.select("#header").append("h4").text(title_end);

              drawScatterplotMatrix(data);
        }
		else if(feat == 'mds-euc'){

		    d3.select("#header").text("MDS (Euclidean distance) in 2D Scatterplot PCA loaded attributes");
		    d3.select("#header").append("h4").text(title_end);

            d3.json('http://localhost:5000/data/' + data+'/feature/mds?metric=euclidean', function(result) {
              drawScatterPlot(result)
           });
        }
		else if(feat == 'mds-corr'){
          d3.select("#header").text("MDS (Correlation distance) in 2D Scatterplot PCA loaded attributes");
          d3.select("#header").append("h4").text(title_end);


		  d3.json('http://localhost:5000/data/' + data+'/feature/mds?metric=correlation', function(result) {
              drawScatterPlot(result)
            });
        }
		else if(feat == 'scatterplot-pca'){
		   d3.select("#header").text("Top two PCA vectors via 2D scatterplot"+title_end);

          d3.json('http://localhost:5000/data/' + data+'/feature/scatterplot-pca', function(result) {
              drawScatterPlot(result)
           });
        }
		else{

		   d3.select("#header").text("Screeplot"+title_end);

		  d3.json('http://localhost:5000/data/' + data+'/feature/screeplot', function(result) {
		       drawScreePlot(result)
           });
        }
	});


	function drawScatterPlot(result){
	  console.log(result);
	  d3.selectAll("svg").remove();

      var svg = d3.select("#graph")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");

        var x = d3.scaleLinear()
          .domain([d3.min(result.x1) - 1, d3.max(result.x1) + 1])
          .range([ 0, width ]);
        svg.append("g")
           .attr("transform", "translate(0," + (height ) + ")")
          .call(d3.axisBottom(x));
        // Add Y axis
        var y = d3.scaleLinear()
          .domain([d3.min(result.x2) - 1, d3.max(result.x2) + 1])
          .range([ height - 25, 0]);
          svg.append("g")
            .call(d3.axisLeft(y));
        // Add dots

        var tag1 = 'Principal Component 1', tag2 = 'Principal Component 2';
        if(feat.includes('mds')){
            tag1 = 'MDS Component 1';
            tag2 = 'MDS Component 2';
        }
            svg.append("text")
           .attr("transform", "translate(" + (width / 2) + " ," + (height + margin.bottom - 20) + ")")
           .style("text-anchor", "middle")
           .text(tag1)
           .attr("font-family", "Saira Condensed");


        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 10)
            .attr("x",0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .text(tag2)
            .attr("font-family", "Saira Condensed");

        scatter_data = convert_data(result)
        drawLegend(result.cluster, svg)
        color_arr = {0 : "69b3a2", 1: "30B33A", 2:"B32A14", 3:"DE95AD"}


        console.log(scatter_data)
        svg.append("g").selectAll(".dot")
          .data(scatter_data)
          .enter()
          .append("circle")
              .attr("class", "dot")
            .attr("cx", function (d) {return x(d[0]); } )
            .attr("cy", function (d) { return y(d[1]); } )
            .attr("r", 3)
            .style("fill", function(d){ return color_arr[d[2]]; })

    }

    function drawLegend(cluster, svg){
        var uniq_Arr = cluster.filter(uniq)
        console.log(uniq_Arr)
        if (uniq_Arr.length > 1)
        {
            var legend = [{"color" : "#69b3a2", "label" : "Cluster 1"}, {"color" : "#30B33A", "label" : "Cluster 2"}, {"color" : "#B32A14", "label" : "Cluster 3"}, {"color" : "#DE95AD", "label" : "Cluster 4"}];
            var margin_legend = 10;

            svg.selectAll("g.legend").data(legend).enter().append("g")
            .attr("class", "legend").attr("transform", function(d,i) {
                return "translate(" + margin_legend + "," + (margin_legend + i*20) + ")";
            }).each(function(d, i) {
                d3.select(this).append("rect").attr("width", 30).attr("height", 15)
                .attr("fill", d.color);
                d3.select(this).append("text").attr("text-anchor", "start")
                .attr("x", 30+10).attr("y", 15/2).attr("dy", "0.35em")
                .text(d.label);
            });
        }

    }
    var uniq = function onlyUnique(value, index, self) {
        return self.indexOf(value) === index;
    }

    function convert_data(result) {
      var scatter_data = [];
      for ( var i = 0; i < result.x1.length; i++ ) {
              scatter_data.push([result.x1[i], result.x2[i], result.cluster[i]]);
      }
      return scatter_data;
    }

	function drawScreePlot(result){
      drawBarChart(result);

    }

    function drawBarChart(result){
    console.log(result);
	dc_table = frequencyCount(result);
	dc_table.Count = +dc_table.Count;
	d3.selectAll("svg").remove();
    //
      var margin = {top: 10, right: 30, bottom: 60, left: 50};
	//var margin = {top: 10, right: 30, bottom: 50, left: 40};
	var width = 600 - margin.left - margin.right, height = 550 - margin.top - margin.bottom;
	var svg = d3.select("#graph")
	  .append("svg")
	  .attr("width", width + margin.left + margin.right)
	  .attr("height", height + margin.top + margin.bottom);

	var  x = d3.scaleBand().padding(0.3), y = d3.scaleLinear(), theData = dc_table;
	x.domain(theData.map(function (d) { return d.Category; }));
	y.domain([0, 100]);

    var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + (margin.top  )+ ")");

    g.append("g")
    .attr("class", "axis axis--x");

    g.append("g")
    .attr("class", "axis axis--y");

    g.append("text")
    .attr("transform", "translate("+(width/2)+"," + (height + margin.bottom - 20)+")")
         .style("text-anchor", "middle")
         .text('Principal Components');

    g.append("text")
    .attr("transform", "rotate(-90)")
    .attr("x", 0 - (height / 2))
    .attr("y", 0 - margin.left)
    .attr("dy", "1.4em")
    .attr("text-anchor", "middle")
    .text("Explained Variance in Percent");

    // var bounds = svg.node().getBoundingClientRect(),
    //   width = bounds.width - margin.left - margin.right,
    //   height = bounds.height - margin.top - margin.bottom - 10;

    x.rangeRound([0, width]);
    y.rangeRound([height, 0]);

    g.select(".axis--x")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));

    g.select(".axis--y")
     .call(d3.axisLeft(y));

    var bars = g.selectAll(".bar")
	      .data(theData);

	bars
      .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function (d) { return x(d.Category); })
      .attr("y", function (d) { return y(d.Count); })
      .attr("width", x.bandwidth())
      .attr("height", function (d) { return height - y(d.Count); })
      .style("fill", barColor)
      .style("stroke", strokeColor)
      .style("stroke-width", strokeBorder);


	  g.append("path")
      .datum(theData)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-width", 3)
      .attr("d", d3.line()
        .x(function(d) { return x(d.Category) })
        .y(function(d) { return y(d.Cum) })
        )


      temp = [[1, 75], [2, 75], [3, 75], [4, 75], [5, 75], [8, 75], [12, 75], [16, 75]]
	  g.append("path")
      .datum(temp)
      .attr("fill", "none")
      .attr("stroke", "green")
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(function(d) { return x(d[0]) })
        .y(function(d) { return y(d[1]) })
        )

      console.log(data)
      var no = 0;
      if(data == 'orig'){
        no = x(5)+4;
        console.log('orig')
      }
      else if(data == 'sampled'){
        console.log('sampled')
        no = x(5)+5;
      }
      else{
        console.log('strat')
        no = x(5)+10.5 ;
      }

    console.log(no);
    g.append("line")
    .attr("x1", no)  //<<== change your code here
    .attr("y1", y(0))
    .attr("x2", no)  //<<== and here
    .attr("y2", y(height - margin.top - margin.bottom))
    .style("stroke-width", 1.5)
    .style("stroke", "green")
    .style("fill", "none");


}


function frequencyCount(arr) {
    var result = [];
    for(var i = 0; i < arr.x.length; i++){
      result.push({'Category': arr.x[i], 'Count':arr.y[i], 'Cum': arr.z[i]});
    }
    return result;
}




	function drawScatterplotMatrix(sample){
      d3.selectAll("svg").remove();
	  console.log(sample)

      var width = 900,
          size = 230,
          padding = 20;
	  height = 500 - margin.top - margin.bottom;

      var x = d3.scaleLinear()
          .range([padding / 2, size - padding / 2]);

      var y = d3.scaleLinear()
          .range([size - padding / 2, padding / 2]);

      var xAxis = d3.axisBottom()
          .scale(x)
          .ticks(6);

      var yAxis = d3.axisLeft()
          .scale(y)
          .ticks(6);


      d3.csv("http://localhost:5000/data/"+ sample+"/feature/scatterplot-matrix"+ "?" + Math.floor(Math.random() * 1000), function(error, data_mat) {
        if (error) throw error;
        console.log(data_mat);
        var domainByTrait = {},
            traits = d3.keys(data_mat[0]).filter(function(d) { return d !== "cluster"; }),
            n = traits.length;
        console.log(traits);

        color_arr = {0 : "69b3a2", 1: "30B33A", 2:"B32A14", 3:"DE95AD"}

        traits.forEach(function(trait) {
          domainByTrait[trait] = d3.extent(data_mat, function(d) { return d[trait]; });
        });

        xAxis.tickSize(size * n);
        yAxis.tickSize(-size * n);

        var brush = d3.brush()
            .on("start", brushstart)
            .on("brush", brushmove)
            .on("end", brushend)
            .extent([[0,0],[size,size]]);

        var svg = d3.select("#graph").append("svg")
            .attr("width", size * n + padding + 150)
            .attr("height", size * n + padding+150)
          .append("g")
            .attr("transform", "translate(" + padding + "," + padding / 2 + ")");

        svg.selectAll(".x.axis")
            .data(traits)
          .enter().append("g")
            .attr("class", "x axis")
            .attr("transform", function(d, i) { return "translate(" + (n - i - 1) * size + ",0)"; })
            .each(function(d) { x.domain(domainByTrait[d]); d3.select(this).call(xAxis); });

        svg.selectAll(".y.axis")
            .data(traits)
          .enter().append("g")
            .attr("class", "y axis")
            .attr("transform", function(d, i) { return "translate(0," + i * size + ")"; })
            .each(function(d) { y.domain(domainByTrait[d]); d3.select(this).call(yAxis); });
        drawLegend(data_mat.map(d => d['cluster']), svg)

        var cell = svg.selectAll(".cell")
            .data(cross(traits, traits))
          .enter().append("g")
            .attr("class", "cell")
            .attr("transform", function(d) { return "translate(" + (n - d.i - 1) * size + "," + d.j * size + ")"; })
            .each(plot);

        // Titles for the diagonal.
        cell.filter(function(d) { return d.i === d.j; }).append("text")
            .attr("x", padding)
            .attr("y", padding)
            .attr("dy", ".71em")
            .text(function(d) { return d.x; });

        cell.call(brush);

        function plot(p) {
          var cell = d3.select(this);

          x.domain(domainByTrait[p.x]);
          y.domain(domainByTrait[p.y]);

          cell.append("rect")
              .attr("class", "frame")
              .attr("x", padding / 2)
              .attr("y", padding / 2)
              .attr("width", size - padding)
              .attr("height", size - padding);

          cell.selectAll("circle")
              .data(data_mat)
            .enter().append("circle")
              .attr("cx", function(d) { return x(d[p.x]); })
              .attr("cy", function(d) { return y(d[p.y]); })
              .attr("r", 4)
              .style("fill", function(d) { return color_arr[d.cluster]; });
        }

        var brushCell;

        // Clear the previously-active brush, if any.
        function brushstart(p) {
          if (brushCell !== this) {
            d3.select(brushCell).call(brush.move, null);
            brushCell = this;
          x.domain(domainByTrait[p.x]);
          y.domain(domainByTrait[p.y]);
          }
        }

        // Highlight the selected circles.
        function brushmove(p) {
          var e = d3.brushSelection(this);
          svg.selectAll("circle").classed("hidden", function(d) {
            return !e
              ? false
              : (
                e[0][0] > x(+d[p.x]) || x(+d[p.x]) > e[1][0]
                || e[0][1] > y(+d[p.y]) || y(+d[p.y]) > e[1][1]
              );
          });
        }

        // If the brush is empty, select all circles.
        function brushend() {
          var e = d3.brushSelection(this);
          if (e === null) svg.selectAll(".hidden").classed("hidden", false);
        }
      });

      function cross(a, b) {
        var c = [], n = a.length, m = b.length, i, j;
        for (i = -1; ++i < n;) for (j = -1; ++j < m;) c.push({x: a[i], i: i, y: b[j], j: j});
        return c;
      }

    }

	</script>



  </body>
</html>